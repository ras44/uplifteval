```{r}
library(grf)
library(ggplot2)

# Data parameters
n = 2000; p = 10

# Features
X = matrix(rnorm(n*p), n, p)
X.test = matrix(rnorm(n*p), n, p)

# Treatment
W = rbinom(n, 1, 0.4 + 0.2 * (X[,1] > 0))
W.test = rbinom(n, 1, 0.4 + 0.2 * (X.test[,1] > 0))

# Response
Y = pmax(X[,1], 0) * W + X[,2] + pmin(X[,3], 0) + rnorm(n)
Y.test = pmax(X.test[,1], 0) * W.test + X.test[,2] + pmin(X.test[,3], 0) + rnorm(n)

# Train a causal forest
tau.forest = causal_forest(X, Y, W)
tau.hat = predict(tau.forest, X.test)

# Estimate the conditional average treatment effect on the full sample (CATE)
average_treatment_effect(tau.forest, target.sample = "all")

# Estimate the conditional average treatment effect on the treated sample (CATT).
# Here, we don't expect much difference between the CATE and the CATT, since
# treatment assignment was randomized.
average_treatment_effect(tau.forest, target.sample = "treated")
```
